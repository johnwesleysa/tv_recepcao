<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Painel de Administração - Slideshow Manager</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
</head>
<body>

  <header class="main-header">
    <div class="header-logo">
      <div class="logo-icon">E</div>
      <div>
        <strong>Eleva</strong>
        <span>Slideshow Manager</span>
      </div>
    </div>
    <nav class="main-nav">
      <a href="#" class="nav-link active">Gerenciamento</a>
      <a href="{{ url_for('index') }}" target="_blank" class="nav-link">Abrir Slideshow</a>
    </nav>
    <div class="header-actions">
      <a href="{{ url_for('logout') }}" class="btn btn-secondary">Sair</a>
    </div>
  </header>

  <main class="main-container">

    <div id="status-card" class="card status-card status-{{ status_video.status }}">
      <div class="status-icon"></div>
      <div class="status-content">
        <h3>Status do Vídeo do Slideshow</h3>
        <p><strong>Status:</strong> <span id="status-texto">{{ status_video.status|capitalize }}</span></p>
        <p><strong>Mensagem:</strong> <span id="status-mensagem">{{ status_video.mensagem }}</span></p>
        <div class="progress-bar-container">
            <div id="progress-bar" class="progress-bar">0%</div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <h2>Gerenciamento do Slideshow</h2>
      </div>
      <div class="card-body">
        <form id="upload-form" class="form-upload">
          <label for="file-upload" class="custom-file-upload">
            Selecionar Arquivos
            <span id="file-name">Nenhum arquivo selecionado.</span>
          </label>
          <input id="file-upload" type="file" name="arquivos" multiple accept="image/*,video/*">
          <button type="submit" class="btn btn-orange" id="upload-button">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/></svg>
            Enviar mídia
          </button>
        </form>
        <div class="progress-bar-container" id="upload-progress-container" style="display: none; margin-top: 16px;">
            <div id="upload-progress-bar" class="progress-bar" style="background-color: var(--primary-orange);">0%</div>
        </div>
        <p id="upload-status-text" style="font-size: 14px; color: var(--text-light); margin-top: 8px;"></p>

        <hr style="margin: 24px 0; border: none; border-top: 1px solid #dee2e6;">
        <form action="{{ url_for('regenerate_thumbnails') }}" method="post">
            <p style="color: #6c757d; font-size: 14px; margin-bottom: 12px;">Se vídeos antigos não estiverem mostrando a miniatura, clique aqui para recriá-las.</p>
            <button type="submit" class="btn btn-secondary">Recriar Miniaturas para Vídeos Antigos</button>
        </form>
      </div>
    </div>

    <div class="card">
        <div class="card-header">
            <h3>Tempo de Transição (para imagens)</h3>
        </div>
        <div class="card-body">
            <form method="post" class="form-inline">
                <div class="form-group">
                    <label for="tempo">Tempo em milissegundos</label>
                    <input type="number" name="tempo" id="tempo" value="{{ tempo }}" min="1000" step="100">
                </div>
                <button type="submit" class="btn btn-primary">Salvar tempo</button>
            </form>
        </div>
    </div>

    <div class="card">
      <div class="card-header space-between">
        <h3>Lista de Mídias</h3>
        <label class="custom-checkbox-label">
          <input type="checkbox" id="check-tudo">
          <span>Selecionar tudo</span>
        </label>
      </div>
      <div class="card-body">
        <form id="form-deletar" method="post" action="{{ url_for('deletar_multiplas') }}">
          <ul id="lista">
            {% for img in imagens %}
              <li data-id="{{ img.id }}" data-type="{{ img.resource_type }}">
                <div class="media-card-checkbox">
                  <input type="checkbox" name="selecionadas" value="{{ img.id }}" class="checkbox-imagem">
                </div>
                <div class="media-card-preview">
                  {% if img.thumbnail_url %}
                    <img src="{{ img.thumbnail_url }}" alt="Miniatura de {{ img.id }}" class="media-thumbnail">
                  {% else %}
                    <svg class="media-icon" xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" viewBox="0 0 16 16"><path d="m11.596 8.697-6.363 3.692c-.54.313-1.233-.066-1.233-.697V4.308c0-.63.692-1.01 1.233-.696l6.363 3.692a.802.802 0 0 1 0 1.393z"/></svg>
                  {% endif %}
                </div>
                <div class="media-card-info">
                  <span class="media-title">Mídia {{ loop.index }}</span>
                  <span class="media-filename">{{ img.id }}</span>
                </div>
              </li>
            {% endfor %}
          </ul>
          <div class="card-footer">
            <button id="botao-deletar" type="submit" class="btn btn-danger">Deletar Selecionados</button>
            <button type="button" onclick="salvarOrdem()" class="btn btn-primary">Atualizar Ordem e Gerar Vídeo</button>
          </div>
        </form>
      </div>
    </div>

  </main>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

  <script>
    // Função para capitalizar texto
    function capitalizar(string) {
      if (!string) return '';
      return string.charAt(0).toUpperCase() + string.slice(1);
    }

    // Função para verificar status da GERAÇÃO de vídeo (após o upload)
    function verificarStatus() {
      fetch("{{ url_for('generation_status') }}")
        .then(response => response.json())
        .then(data => {
          const statusCard = document.getElementById('status-card');
          const statusTexto = document.getElementById('status-texto');
          const statusMensagem = document.getElementById('status-mensagem');
          const progressBar = document.getElementById('progress-bar');
          
          statusTexto.textContent = capitalizar(data.status);
          statusMensagem.textContent = data.mensagem;
          statusCard.className = 'card status-card status-' + data.status;

          const progress = data.progress || 0;
          progressBar.style.width = progress + '%';
          progressBar.textContent = progress + '%';

          if (data.status === 'processando') {
            setTimeout(verificarStatus, 2000);
          }
        })
        .catch(error => console.error('Erro ao verificar status:', error));
    }
    
    // Função para salvar a ordem das mídias
    function salvarOrdem() {
      const ordem = [];
      $("#lista li").each(function () {
        ordem.push({
          id: $(this).data("id"),
          resource_type: $(this).data("type")
        });
      });
      fetch("{{ url_for('atualizar_ordem') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ordem })
      }).then(res => res.json()).then(() => {
        window.location.reload();
      });
    }

    // Código principal que roda quando a página carrega
    document.addEventListener('DOMContentLoaded', function() {
        // Inicia a verificação se a página recarregar durante um processamento
        if (document.getElementById('status-texto').textContent.trim().toLowerCase() === 'processando') {
            verificarStatus();
        }

        // --- LÓGICA DE UPLOAD INTELIGENTE ---
        const uploadForm = document.getElementById('upload-form');
        const uploadButton = document.getElementById('upload-button');
        const fileInput = document.getElementById('file-upload');
        const uploadProgressContainer = document.getElementById('upload-progress-container');
        const uploadProgressBar = document.getElementById('upload-progress-bar');
        const uploadStatusText = document.getElementById('upload-status-text');

        uploadForm.addEventListener('submit', async function(event) {
            event.preventDefault(); // Impede o envio do formulário padrão
            
            const files = fileInput.files;
            if (files.length === 0) {
                alert('Por favor, selecione ao menos um arquivo.');
                return;
            }

            uploadButton.disabled = true;
            uploadButton.textContent = 'Enviando...';
            uploadProgressContainer.style.display = 'block';
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const formData = new FormData();
                formData.append('file', file);

                const progress = Math.round(((i + 1) / files.length) * 100);
                uploadProgressBar.style.width = progress + '%';
                uploadProgressBar.textContent = progress + '%';
                uploadStatusText.textContent = `Enviando arquivo ${i + 1} de ${files.length}: ${file.name}`;
                
                try {
                    const response = await fetch("{{ url_for('upload_media') }}", {
                        method: 'POST',
                        body: formData
                    });

                    const result = await response.json();
                    if (!response.ok) { // Verifica se a resposta HTTP foi bem-sucedida
                        throw new Error(result.message || 'Erro no servidor.');
                    }
                } catch (error) {
                    alert(`Ocorreu um erro ao enviar o arquivo ${file.name}: ${error.message}. O processo foi interrompido.`);
                    uploadButton.disabled = false;
                    uploadButton.textContent = 'Enviar mídia'; // Restaura o texto original
                    uploadProgressContainer.style.display = 'none';
                    uploadStatusText.textContent = '';
                    return; // Interrompe o loop em caso de erro
                }
            }

            // Quando todos os uploads terminarem com sucesso
            uploadStatusText.textContent = 'Todos os arquivos foram enviados! Iniciando processamento do vídeo final...';
            
            // Dispara a geração do vídeo no backend
            await fetch("{{ url_for('start_generation') }}", { method: 'POST' });

            alert('Upload concluído! A página será atualizada para mostrar o progresso da criação do vídeo.');
            window.location.reload();
        });
    });

    // Lógica do jQuery para Sortable, seleção e deleção
    $(function () {
      $("#lista").sortable({
        placeholder: "media-card-placeholder",
        tolerance: "pointer",
        start: function(event, ui) {
            ui.placeholder.height(ui.item.height());
        }
      });
      
      $("#check-tudo").on("change", function () {
        $(".checkbox-imagem").prop("checked", this.checked).trigger("change");
      });
      
      $(".checkbox-imagem").on("change", function () {
        $(this).closest('li').toggleClass('selected', this.checked);
        const anyChecked = $(".checkbox-imagem:checked").length > 0;
        $("#botao-deletar").toggle(anyChecked);
      }).trigger('change');
      
      $("#form-deletar").on("submit", function (e) {
        const count = $(".checkbox-imagem:checked").length;
        if (count === 0 || !confirm(`Tem certeza que deseja deletar ${count} mídia(s)?`)) {
          e.preventDefault();
        }
      });
      
      $('#file-upload').on('change', function() {
        const files = $(this)[0].files;
        $('#file-name').text(files.length > 1 ? `${files.length} arquivos selecionados.` : (files.length === 1 ? files[0].name : 'Nenhum arquivo selecionado.'));
      });
    });
  </script>
</body>
</html>